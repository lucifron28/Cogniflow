<div class="file-tree" cdkDropListGroup>
    <!-- Root-level actions -->
    <div class="tree-actions">
        <button (click)="openCreateFolderModal(null)" class="btn-new-folder" title="New Folder">
            <app-icon name="folder-plus" size="sm"></app-icon>
            <span>New Folder</span>
        </button>
        <button (click)="createNoteInFolder(null)" class="btn-new-note" title="New Note">
            <app-icon name="plus" size="sm"></app-icon>
            <span>New Note</span>
        </button>
    </div>

    <!-- Tree -->
    <div class="tree-content" cdkDropList id="root-drop-list" [cdkDropListData]="tree()"
        [cdkDropListConnectedTo]="allDropListIds()" (cdkDropListDropped)="onDrop($event, null)">

        @if (tree().length === 0) {
        <div class="empty-state">
            <app-icon name="folder" size="lg"></app-icon>
            <p>No files or folders</p>
            <button (click)="openCreateFolderModal(null)" class="btn-create-first">
                Create Folder
            </button>
        </div>
        } @else {
        @for (node of tree(); track node.id) {
        @if (node.type === 'folder') {
        <!-- Folder -->
        <div class="tree-node folder-node">
            <div class="node-content" (click)="toggleFolder(node)" (contextmenu)="showContextMenu($event, node)">
                <div class="node-icon">
                    @if (node.expanded) {
                    <app-icon name="chevron-down" size="sm"></app-icon>
                    } @else {
                    <app-icon name="chevron-right" size="sm"></app-icon>
                    }
                </div>
                <app-icon [name]="node.expanded ? 'folder-open' : 'folder'" size="sm"></app-icon>
                <span class="node-name">{{ node.name }}</span>
            </div>

            <!-- Folder's drop zone -->
            @if (node.expanded) {
            <div class="node-children" cdkDropList [id]="'drop-' + node.id" [cdkDropListData]="node.children || []"
                [cdkDropListConnectedTo]="allDropListIds()" (cdkDropListDropped)="onDrop($event, node)">

                @if (!node.children || node.children.length === 0) {
                <div class="empty-folder-drop-zone">Drop notes here</div>
                } @else {
                @for (child of node.children; track child.id) {
                @if (child.type === 'folder') {
                <!-- Recursive folder -->
                <div class="tree-node folder-node">
                    <div class="node-content" (click)="toggleFolder(child)"
                        (contextmenu)="showContextMenu($event, child)">
                        <div class="node-icon">
                            @if (child.expanded) {
                            <app-icon name="chevron-down" size="sm"></app-icon>
                            } @else {
                            <app-icon name="chevron-right" size="sm"></app-icon>
                            }
                        </div>
                        <app-icon [name]="child.expanded ? 'folder-open' : 'folder'" size="sm"></app-icon>
                        <span class="node-name">{{ child.name }}</span>
                    </div>

                    @if (child.expanded) {
                    <div class="node-children" cdkDropList [id]="'drop-' + child.id"
                        [cdkDropListData]="child.children || []" [cdkDropListConnectedTo]="allDropListIds()"
                        (cdkDropListDropped)="onDrop($event, child)">

                        @if (!child.children || child.children.length === 0) {
                        <div class="empty-folder-drop-zone">Drop notes here</div>
                        } @else {
                        @for (item of child.children; track item.id) {
                        <div class="tree-node note-node" cdkDrag [cdkDragData]="item">
                            <div class="node-content" (click)="openNote(item.id)"
                                (contextmenu)="showContextMenu($event, item)">
                                <app-icon name="document" size="sm"></app-icon>
                                <span class="node-name">{{ item.name }}</span>
                            </div>
                        </div>
                        }
                        }
                    </div>
                    }
                </div>
                } @else {
                <!-- Note -->
                <div class="tree-node note-node" cdkDrag [cdkDragData]="child">
                    <div class="node-content" (click)="openNote(child.id)"
                        (contextmenu)="showContextMenu($event, child)">
                        <app-icon name="document" size="sm"></app-icon>
                        <span class="node-name">{{ child.name }}</span>
                    </div>
                </div>
                }
                }
                }
            </div>
            }
        </div>
        } @else {
        <!-- Root-level Note -->
        <div class="tree-node note-node" cdkDrag [cdkDragData]="node">
            <div class="node-content" (click)="openNote(node.id)" (contextmenu)="showContextMenu($event, node)">
                <app-icon name="document" size="sm"></app-icon>
                <span class="node-name">{{ node.name }}</span>
            </div>
        </div>
        }
        }
        }
    </div>

    <!-- Context Menu -->
    @if (contextMenu().show) {
    <div class="context-menu" [style.left.px]="contextMenu().x" [style.top.px]="contextMenu().y"
        (click)="$event.stopPropagation()">
        @if (contextMenu().node?.type === 'folder') {
        <button (click)="contextAction('new-folder')" class="context-menu-item">
            <app-icon name="folder-plus" size="sm"></app-icon>
            <span>New Folder</span>
        </button>
        <button (click)="contextAction('new-note')" class="context-menu-item">
            <app-icon name="plus" size="sm"></app-icon>
            <span>New Note</span>
        </button>
        <div class="context-menu-divider"></div>
        }

        <button (click)="contextAction('rename')" class="context-menu-item">
            <app-icon name="edit" size="sm"></app-icon>
            <span>Rename</span>
        </button>

        @if (contextMenu().node?.type === 'note') {
        <button (click)="contextAction('copy-link')" class="context-menu-item">
            <app-icon name="link" size="sm"></app-icon>
            <span>Copy Link</span>
        </button>
        }

        @if (contextMenu().node?.type === 'note' && contextMenu().node?.parentId) {
        <button (click)="contextAction('move-out')" class="context-menu-item">
            <app-icon name="arrow-up" size="sm"></app-icon>
            <span>Move to Root</span>
        </button>
        }

        <div class="context-menu-divider"></div>
        <button (click)="contextAction('delete')" class="context-menu-item danger">
            <app-icon name="trash" size="sm"></app-icon>
            <span>Delete</span>
        </button>
    </div>
    }

    <!-- Create Folder Modal -->
    @if (showCreateFolderModal()) {
    <div class="modal-backdrop" (click)="showCreateFolderModal.set(false)">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>New Folder</h3>
                <button (click)="showCreateFolderModal.set(false)" class="btn-close">
                    <app-icon name="x" size="sm"></app-icon>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" [(ngModel)]="newFolderNameValue" placeholder="Folder name..."
                    (keydown.enter)="createFolder()" class="form-input" autofocus />
            </div>
            <div class="modal-footer">
                <button (click)="showCreateFolderModal.set(false)" class="btn-secondary">Cancel</button>
                <button (click)="createFolder()" [disabled]="!newFolderName().trim()" class="btn-primary">
                    Create
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Rename Modal -->
    @if (showRenameModal()) {
    <div class="modal-backdrop" (click)="showRenameModal.set(false)">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Rename {{ renameTarget()?.type }}</h3>
                <button (click)="showRenameModal.set(false)" class="btn-close">
                    <app-icon name="x" size="sm"></app-icon>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" [(ngModel)]="renameValueBinding" (keydown.enter)="rename()" class="form-input"
                    autofocus />
            </div>
            <div class="modal-footer">
                <button (click)="showRenameModal.set(false)" class="btn-secondary">Cancel</button>
                <button (click)="rename()" [disabled]="!renameValue().trim()" class="btn-primary">
                    Rename
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Toast Notification -->
    @if (toastMessage()) {
    <div class="toast-notification">
        <app-icon name="check-circle" size="sm"></app-icon>
        <span>{{ toastMessage() }}</span>
    </div>
    }
</div>